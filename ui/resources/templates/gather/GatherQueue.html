<!doctype html>
<html lang=en xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Gather Queue - PANDAS</title>
    <link rel="stylesheet" href="../../static/assets/Global.css" th:href="@{/assets/Global.css}">
    <script src="../../static/assets/Global.js" th:src="@{/assets/Global.js}" defer></script>

    <style>
        .gather-queue-table {
            border-collapse: collapse;
            border-radius: 8px;
        }

        .gather-queue-table tr {
            border: 1px solid #ebedef;
            border-bottom: none;
        }

        .gather-queue-table tr:last-child {
            border-bottom: 1px solid #ebedef;
        }

        .gather-queue-table td {
            padding: 0 8px;
        }

        .gather-queue-table .start-time {
            color: #666;
            cursor: default;
        }

        .gather-method {
            color: #666;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 80%;
        }

        .gather-state {
            display: inline-block;
            padding: 4px 8px;
            font-size: 75%;
            white-space: nowrap;
            border-radius: .5rem;
            background: #ddd;
            text-transform: capitalize;
        }

        .gather-state-gathering {
            background: #a3efa3;
        }

        .gather-state-archiving {
            background: #afbeff;
        }

        .gather-state-deleting {
            background: #fdd;
        }

        .title-link {
            font-weight: bold;
        }

        .title-details, .title-details a {
            font-size: 80%;
            color: #666;
        }

        .conflict {
            color: #d37101;
            font-size: 80%;
            font-variant: all-small-caps;
        }

        .conflict a {
            color: #d37101;
        }
    </style>
</head>
<body>
<nav th:replace="~{_layout.html :: sidebar (activeItem='Gather Queue')}"></nav>
<main>
    <header></header>

    <div>
        <strong>Status:</strong> <span th:text="${gathererStatus}"></span>
        <form sec:authorize="hasAuthority('PRIV_CONTROL_GATHERER')"
              th:if="${gathererStatus.contains('running')}"
              th:action="@{/queue/pause}" method="post" style="display: inline">
            <button class="btn btn-secondary">Pause Gatherer</button>
        </form>
        <form sec:authorize="hasAuthority('PRIV_CONTROL_GATHERER')"
               th:unless="${gathererStatus.contains('running')}"
               th:action="@{/queue/unpause}" method="post" style="display: inline">
            <button class="btn btn-secondary">Unpause Gatherer</button>
        </form>
    </div>

    <h2>Gathering</h2>

    <span th:if="${gatheringInstances.isEmpty()}">Nothing is currently gathering.</span>
    <form method=post th:action="@{/queue}">
    <table class="table gather-queue-table">
        <th:block th:each="instance: ${gatheringInstances}">
            <tr th:replace="~{gather/GatherQueueFragments.html :: instanceRow(${instance}, ~{ :: .actions})}">
                <td class="actions">
                    <button sec:authorize="hasPermission(#vars.instance.title, 'edit')"
                            th:formaction="@{|/instances/${instance.id}/stop|}" class="btn btn-secondary"><i
                            class="icon stop"></i> Stop
                    </button>
                </td>
            </tr>
        </th:block>
    </table>
    </form>

    <section th:if="${!queuedGathers.isEmpty()}">
        <h2 id="queued">Scheduled for today</h2>
        <table class="table gather-queue-table">
            <tr th:each="gather: ${queuedGathers}">
                <td>
                    <a th:href="${gather.title.primarySeedUrl}" target="_blank">
                        <img th:src="${@link.thumbnail(gather.title)}" width=67 height=50>
                    </a>
                </td>
                <td th:with="blocker = ${conflicts.get(gather.title.id)}">
                    <a th:href="${@link.to(gather.title)}" th:text="${gather.title.name}" href="../TitleView.html"
                       class="title-link">Fishes of Australia</a><br>
                    <span class="title-details">
                        <span th:text="${gather.title.humanId}">nla.arc-186737-20210824-1143</span>
                        <span th:text="${gather.title.owner.userid}">ckent</span>
                        <span th:text="${gather.title.agency?.organisation?.alias}">NLA</span>
                    </span>
                    <div class="conflict" th:if="${blocker != null}">
                        Waiting for <a th:href="${@link.toInstance(blocker.instanceId())}" th:text="${blocker.titleName()}"
                                      class="title-link">Fishes of Australia</a>
                                    (<th:block th:text="${blocker.reason()}">same host</th:block>)
                    </div>
                </td>
                <td align="center">
                    <span th:text="${gather.method.name}" class="gather-method">Heritrix</span><br>
                </td>
                <td class="start-time">
                    to begin <time th:datetime="${gather.nextGatherDate}" th:text="${@dateFormats.dayDateTime.format(gather.nextGatherDate)}"
                            th:title="${'Scheduled for ' + @dateFormats.dayDateTime.format(gather.nextGatherDate)}">1 hour ago</time><br>
                </td>
            </tr>
        </table>
    </section>

    <section>
        <h2>Failed</h2>
        <form id="failed-form" sec:authorize="hasAuthority('PRIV_CONTROL_GATHERER')" method="post">
            <button type="submit" class="btn-danger selected-action-failed" th:formaction="@{/queue/retry-selected}">Retry selected</button>
            <button type="submit" class="btn-danger selected-action-failed" th:formaction="@{/queue/delete-selected}">Delete selected</button>
        </form>

        <span th:if="${failedInstances.isEmpty()}">No failed instances.</span>
        <table th:if="${!failedInstances.isEmpty()}" class="table gather-queue-table">
            <thead>
                <tr>
                    <th sec:authorize="hasAuthority('PRIV_CONTROL_GATHERER')">
                        <input type="checkbox" onchange="toggleSelectAllFailed(this)" id="selectAllFailedCheckbox">
                    </th>
                    <th colspan="3"></th>
                </tr>
            </thead>
            <tbody>
            <th:block th:each="instance: ${failedInstances}">
                <tr th:replace="~{gather/GatherQueueFragments.html :: instanceRow(${instance}, ~{ :: .failed-gather-actions})}">
                    <td class="failed-gather-actions">
                        <form th:if="${instance.stateBeforeFailure != null && instance.stateBeforeFailure.canBeRetried()}"
                              th:action="@{/queue/retry(instance=${instance.id})}" method="post"
                              sec:authorize="hasPermission(#vars.instance.title, 'edit')">
                            <button type="submit" th:text="${'Retry ' + instance.stateBeforeFailure.name}">Retry
                            </button>
                        </form>
                    </td>
                </tr>
                <tr>
                    <td sec:authorize="hasAuthority('PRIV_CONTROL_GATHERER')"></td>
                    <td></td>
                    <td colspan="3">
                        <div style="background: #ffdddd; padding: 4px; margin-bottom: 4px" th:each="exception: ${instance.exceptions}">
                            <strong th:text="${@dateFormats.shortDateTime.format(exception.date)}"></strong>
                            <span style="color: #990000" th:text="${exception.summary + '.'}"></span>
                            <span th:text="${exception.detail}"></span>
                            <span style="color: #990000" th:text="${'[' + exception.originator + ']'}"></span>
                        </div>
                    </td>
                </tr>
            </th:block>
            </tbody>
        </table>
    </section>

    <script th:src="@{/webjars/timeago.js/dist/timeago.min.js}"></script>
    <script>
        timeago.render(document.querySelectorAll('time'));

        function countFailedSelected() {
            return document.querySelectorAll(".selectedFailedInstancesCheckbox:checked").length;
        }

        function updateFailedSelected() {
            let selectAllCheckbox = document.getElementById("selectAllFailedCheckbox");
            if (!selectAllCheckbox) return;
            
            let totalCount = document.querySelectorAll(".selectedFailedInstancesCheckbox").length;
            let selectedCount = countFailedSelected();

            if (selectedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedCount >= totalCount) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = true;
            }

            // Enable/disable action buttons
            let actionButtons = document.querySelectorAll("button.selected-action-failed");
            if (selectedCount > 0) {
                actionButtons.forEach(btn => btn.disabled = false);
            } else {
                actionButtons.forEach(btn => btn.disabled = true);
            }
        }

        function toggleSelectAllFailed(selectAllCheckbox) {
            document.querySelectorAll('.selectedFailedInstancesCheckbox').forEach(el =>
                el.checked = selectAllCheckbox.checked);
            updateFailedSelected();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateFailedSelected();
        });
    </script>
</main>