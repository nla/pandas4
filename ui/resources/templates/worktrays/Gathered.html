<!doctype html>
<html lang=en xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Instances in QA - PANDAS</title>
    <link rel="stylesheet" href="../../static/assets/Global.css" th:href="@{/assets/Global.css}">
    <script src="../../static/assets/Global.js" th:src="@{/assets/Global.js}" defer></script>
</head>
<body>
<nav th:replace="_layout.html :: sidebar"></nav>
<main>
    <header>
        <nav>
            <button class="btn btn-primary selected-action" form=form type=submit
                    th:formaction="@{/instances/archive}"><i class="icon archive"></i>Archive</button>
            <button class="btn btn-danger selected-action" form=form type=submit
                    th:formaction="@{/instances/delete}"
                    onclick="return confirm('Are you certain you wish to delete ' + countSelected() + ' instances? This cannot be undone.');"
            ><i class="icon delete"></i>Delete</button>
        </nav>
        <th:block th:include="worktrays/_worktrays.html :: header('/worktrays/{alias}/gathered')">
        </th:block>
    </header>
    <nav class="breadcrumb">
        <ol>
            <li><a th:href="@{/worktrays/{alias}(alias=${alias})}" style="font-weight: bold">Worktrays</a></li>
            <li class="active">Instances in QA (<span th:text="${gatheredInstances.totalElements}"></span>)</li>
        </ol>
    </nav>

    <style>
        .gathered-table td {
            border-top: 1px solid #ccc;
            padding: 4px 8px;
        }

        .gathered-table td:first-of-type {
            padding: 8px 0;
        }

        .gather-stats {
            font-size: 80%;
            color: #555;
        }
    </style>

    <form id=form method=post th:action="@{''}">
        <table th:fragment="table" class="gathered-table">
            <thead>
            <tr>
                <th><input type=checkbox onchange="toggleSelectAll(this)" id="selectAllCheckbox"></th>
                <th align=left id="titleColumnHeader">Title</th>
                <th>This Gather</th>
                <th>Live Site</th>
                <th>Previous Gather</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="instance: ${gatheredInstances}" th:with="previousGather = ${previousGathers.get(instance.id)}">
                <td>
                    <input type=checkbox class="selectedInstancesCheckbox" name=instance th:value='${instance.id}'
                           onchange="updateSelected()">
                </td>
                <td th:insert="TitleSearch.html :: title-card-text(title=${instance.title})">
                    <a style="font-weight: bold">Example title</a><br>
                    <span>Heritrix</span>
                    <a>jsmith</a>
                </td>
                <td style="text-align: center">
                    <a th:href="@{/instances/{id}/process(id=${instance.id},worktray=${alias})}"><img th:src="${@link.thumbnail(instance)}" width=150 height=100></a><br>
                    <time th:text="${@dateFormats.shortDate(instance.date)}"></time><br>
                    <span class="gather-stats" th:if="${instance.gather != null}" th:text="${instance.gather.stats}">1,234 files 10 MB</span>
                </td>
                <td style="text-align: center; vertical-align: top">
                    <a th:href="${instance.title.titleUrl}"><img th:src="${@link.thumbnail(instance, 'LIVE')}" width=150 height=100></a>
                </td>
                <td style="text-align: center">
                    <th:block th:if="${previousGather != null}">
                        <a th:href="@{/instances/{id}(id=${previousGather.id})}">
                            <img th:src="@{/instances/{id}/thumbnail(id=${previousGather.id})}" width=150 height=100><br>
                        </a>
                        <time th:text="${@dateFormats.shortDate(previousGather.date)}"></time><br>
                        <span class="gather-stats" th:text="${previousGather.stats}">1,234 files 10 MB</span>
                    </th:block>
                </td>
            </tr>
            </tbody>
        </table>
    </form>

    <script>
        function countSelected() {
            return document.querySelectorAll(".selectedInstancesCheckbox:checked").length;
        }

        function updateSelected() {
            let selectAllCheckbox = document.getElementById("selectAllCheckbox");
            let totalCount = document.querySelectorAll(".selectedInstancesCheckbox").length;
            let selectedCount = countSelected();

            if (selectedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedCount >= totalCount) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = true;
            }

            if (selectedCount > 0) {
                document.querySelectorAll("button.selected-action").forEach(btn => btn.disabled = false);
            } else {
                document.querySelectorAll("button.selected-action").forEach(btn => btn.disabled = true);
            }

            // show count in title
            if (selectedCount === 0) {
                document.getElementById("titleColumnHeader").innerText = "Title";
            } else if (selectedCount === 1) {
                document.getElementById("titleColumnHeader").innerText = selectedCount + " instance selected";
            } else {
                document.getElementById("titleColumnHeader").innerText = selectedCount + " instances selected";
            }
        }

        function toggleSelectAll(selectAllCheckbox) {
            document.querySelectorAll('.selectedInstancesCheckbox').forEach(el =>
                el.checked = selectAllCheckbox.checked);
            updateSelected();
        }
    </script>


    <div th:replace="worktrays/_worktrays :: pagination(${gatheredInstances})">
    </div>
</main>